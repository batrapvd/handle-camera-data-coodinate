name: Camera Data Migration

on:
  # Chạy theo lịch - mỗi ngày lúc 2:00 AM UTC
  schedule:
    - cron: '0 2 * * *'
  
  # Cho phép chạy thủ công từ GitHub UI
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of records to process per batch'
        required: false
        default: '1000'
        type: string
      max_batches:
        description: 'Maximum number of batches to process (leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Run in dry-run mode (no actual changes)'
        required: false
        default: false
        type: boolean

jobs:
  migrate-camera-data:
    runs-on: ubuntu-latest
    
    # Timeout after 30 minutes
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run migration
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '1000' }}
          MAX_BATCHES: ${{ github.event.inputs.max_batches }}
        run: |
          echo "Starting camera data migration..."
          echo "Batch size: ${BATCH_SIZE}"
          echo "Max batches: ${MAX_BATCHES:-unlimited}"
          
          python camera_migration.py
          
      - name: Generate migration report
        if: always()
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python -c "
          import psycopg2
          import os
          import json
          from datetime import datetime
          
          conn_string = os.environ.get('DATABASE_URL')
          if conn_string:
              try:
                  conn = psycopg2.connect(conn_string)
                  cur = conn.cursor()
                  
                  # Get statistics
                  cur.execute('''
                      SELECT 
                          COUNT(*) as total_records,
                          COUNT(CASE WHEN camera_processed = TRUE THEN 1 END) as processed,
                          COUNT(CASE WHEN camera_response IS NOT NULL 
                                AND camera_response != '' THEN 1 END) as with_camera_data
                      FROM public.coordinate_speed;
                  ''')
                  record_stats = cur.fetchone()
                  
                  cur.execute('SELECT COUNT(*) FROM public.camera_locations;')
                  location_count = cur.fetchone()[0]
                  
                  cur.execute('SELECT COUNT(*) FROM public.camera_devices;')
                  device_count = cur.fetchone()[0]
                  
                  # Create report
                  report = {
                      'timestamp': datetime.utcnow().isoformat(),
                      'records': {
                          'total': record_stats[0],
                          'processed': record_stats[1],
                          'with_camera_data': record_stats[2]
                      },
                      'camera_locations': location_count,
                      'camera_devices': device_count
                  }
                  
                  print('=== Migration Report ===')
                  print(json.dumps(report, indent=2))
                  
                  # Save to file
                  with open('migration_report.json', 'w') as f:
                      json.dump(report, f, indent=2)
                      
                  cur.close()
                  conn.close()
              except Exception as e:
                  print(f'Failed to generate report: {e}')
          "
          
      - name: Upload migration report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: migration-report-${{ github.run_number }}
          path: |
            migration_report.json
          retention-days: 30
          
      - name: Check migration health
        if: always()
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python -c "
          import psycopg2
          import os
          import sys
          
          conn_string = os.environ.get('DATABASE_URL')
          if conn_string:
              try:
                  conn = psycopg2.connect(conn_string)
                  cur = conn.cursor()
                  
                  # Check for any errors or inconsistencies
                  cur.execute('''
                      SELECT COUNT(*) 
                      FROM public.coordinate_speed 
                      WHERE camera_response IS NOT NULL 
                      AND camera_response != ''
                      AND camera_response NOT LIKE '%error%'
                      AND camera_response NOT LIKE '%204%'
                      AND (camera_processed IS FALSE OR camera_processed IS NULL);
                  ''')
                  pending = cur.fetchone()[0]
                  
                  if pending > 10000:
                      print(f'WARNING: {pending} records still pending processing')
                      sys.exit(1)
                  else:
                      print(f'Health check passed: {pending} records pending')
                      
                  cur.close()
                  conn.close()
              except Exception as e:
                  print(f'Health check failed: {e}')
                  sys.exit(1)
          "

  notify-on-failure:
    needs: migrate-camera-data
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Camera Migration Failed - Run #${context.runNumber}`;
            const body = `The camera data migration workflow failed.
            
            **Run Details:**
            - Run Number: ${context.runNumber}
            - Run ID: ${context.runId}
            - Triggered by: ${context.eventName}
            - Actor: ${context.actor}
            
            Please check the [workflow logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for more details.`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'automation', 'migration']
            });
